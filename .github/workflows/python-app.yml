# This workflow will install Python dependencies, run tests and lint with a single version of Python
# For more information see: https://docs.github.com/en/actions/automating-builds-and-tests/building-and-testing-python

name: Sync Telegram channel to GitHub Pages

on:
  workflow_dispatch:
  schedule:
    - cron: "17 * * * *"
    - cron: "47 * * * *"

permissions:
  contents: write

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Fetch Telegram posts
        env:
          TG_API_ID: ${{ secrets.TG_API_ID }}
          TG_API_HASH: ${{ secrets.TG_API_HASH }}
          TG_SESSION: ${{ secrets.TG_SESSION }}
          TG_CHANNEL: ${{ secrets.TG_CHANNEL }}
          # Public site URL (used in feeds/sitemap). Override with repo variable if needed.
          FEED_SITE_URL: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/
          SITE_URL: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/
          # Optional tuning (set as Repository Variables or hardcode here)
          DOWNLOAD_MEDIA: "true"
          MEDIA_MAX_MB: "200"
          INITIAL_FETCH_LIMIT: "0"
          REFRESH_LAST_N: "500"
          MEDIA_DOWNLOAD_SCOPE: "2000"
        run: |
          python scripts/fetch_telegram.py

      - name: Commit & push if changed
        run: |
          git config user.name "telegram-mirror-bot"
          git config user.email "telegram-mirror-bot@users.noreply.github.com"

          git add docs/data docs/assets docs/feed.xml docs/atom.xml docs/sitemap.xml docs/robots.txt || true

          if git diff --cached --quiet; then
            echo "No changes to commit."
            exit 0
          fi

          git commit -m "Sync Telegram posts (UTC) $(date -u +'%Y-%m-%d %H:%M:%S')"
          git push
